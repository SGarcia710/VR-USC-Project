<!DOCTYPE html>
<html lang="es">
  <head>
    <title>Selector de Atomos</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <script src="./src/three.js"></script>
    <!--<script src="./src/ControllerPickHelper.js"></script>-->
    <script src="./src/DragControls.js"></script>
    <script src="./src/Reflector.js"></script>
    <script src="./src/Refractor.js"></script>
    <script src="./src/Logic.js"></script>
    <script src="./src/datguivr.js"></script>
    <script src="./src/perlin.js"></script>
    <style>
        *{
            margin: 0;
            overflow: hidden;
        }
    </style>
  </head>

  <body>
    <script type="module">
      //import { SceneUtils } from "https://threejsfundamentals.org/threejs/resources/threejs/r110/examples/jsm/utils/SceneUtils.js";
      import * as WEBVR from "./src/WebVR.js";
      import * as Water from "./src/Water2.js";

      const RADIUS = 0.15;
      const PAREDESCUADRO = 4;
      const CANTATOMOS = 100;

      var clock = new THREE.Clock();
      var normal = new THREE.Vector3();
      var relativeVelocity = new THREE.Vector3();
      var logica = new Logic();

      var objetos = [];
      var aja = [];
      var temMOLE = [];
      var container;
      var camera;
      var scene;
      var renderer;
      var agua;
      var textureLoader;
      var isMouseDown;
      var startColor;
      var cont;
      var velX, velY, velZ;
      var pickHelper;
      var gui;
      var gui2;
      var contadorGUI = 0;
      var geoMusic;
      var completaSound;
      var failSound;
      var fullSound;
      var goodSound;
      var lose;
      var ambientalMusic;

      var AtomoTemp = function() {
        this.cant = 0;
      };

      init();
      animate();

      function init() {
        isMouseDown = false;
        container = document.createElement("div");
        document.body.appendChild(container);
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x505050);

        camera = new THREE.PerspectiveCamera(
          70,
          window.innerWidth / window.innerHeight,
          0.1,
          10
        );
        scene.add(camera);

        textureLoader = new THREE.TextureLoader();

        scene.fog = new THREE.FogExp2(0xefd1b5, 0.2);

        var pisoMallaG = new THREE.PlaneBufferGeometry(10, 10, 10, 10);
        var pisoMallaM = new THREE.MeshBasicMaterial({
          color: 0x0000,
          wireframe: true
        });
        var pisoMalla = new THREE.Mesh(pisoMallaG, pisoMallaM);
        pisoMalla.rotation.x = Math.PI * -0.5;
        pisoMalla.position.x = 0;
        scene.add(pisoMalla);

        var cubeTextureLoader = new THREE.CubeTextureLoader();
        cubeTextureLoader.setPath("./assets/textures/");
        var cubeTexture = cubeTextureLoader.load([
          "px.jpg",
          "nx.jpg",
          "py.jpg",
          "ny.jpg",
          "pz.jpg",
          "nz.jpg"
        ]);
        scene.background = cubeTexture;

        //Agua
        var aguaGeometry = new THREE.PlaneBufferGeometry(40, 40);
        var flowMap = textureLoader.load(
          "./assets/textures/water/Water_1_M_Flow.jpg"
        );
        agua = new THREE.Water(aguaGeometry, {
          scale: 2,
          textureWidth: 1024,
          textureHeight: 1024,
          flowMap: flowMap
        });
        agua.position.y = 0.5;
        agua.rotation.x = Math.PI * -0.5;
        scene.add(agua);

        scene.add(new THREE.HemisphereLight(0x606060, 0x404040));
        var light = new THREE.DirectionalLight(0xffffff);
        light.position.set(1, 1, 1).normalize();
        scene.add(light);

        var colors = [];
        colors.push(0xfaf7f0); // Hidrogreno H
        colors.push(0xa10305); // Oxigeno O
        colors.push(0x636363); // Carbono C
        colors.push(0x7edc88); // Sodio plateado  Na
        colors.push(0xf4fa58); // Cloro amarillo verdoso Cl
        colors.push(0x959be9); // Silicio gris brillante Si

        var geometry = new THREE.IcosahedronGeometry(RADIUS, 3);

        for (var i = 0, j = 0; i < CANTATOMOS; i++, j++) {
          if (j == 6) j = 0;

          var object = new THREE.Mesh(
            new THREE.SphereGeometry(RADIUS + 0.1, RADIUS + 0.1, RADIUS + 0.1),
            new THREE.MeshLambertMaterial({ color: colors[j], wireframe: true })
          );

          var atomo = new THREE.Mesh(
            geometry,
            new THREE.MeshLambertMaterial({ color: colors[j] })
          );

          // AGREGA EL BORDE 
          object.add(atomo);
          object.position.x = Math.random() * 4 - 2;
          object.position.y = Math.random() * 20 + 1;
          object.position.z = Math.random() * 4 - 2;

          var Vv = new THREE.Vector3();
          var Vx = Math.random() * 0.01 - 0.005;
          var Vy = Math.random() * 0.01 - 0.005;
          var Vz = Math.random() * 0.01 - 0.005;
                    
          object.userData.velocity = Vv;
          object.userData.velocity.x = Vx;
          object.userData.velocity.y = Vy;
          object.userData.velocity.z = Vz;

          atomo.userData.velocity = Vv;
          atomo.userData.velocity.x = Vx;
          atomo.userData.velocity.y = Vy;
          atomo.userData.velocity.z = Vz;

          atomo.scale.x = 0.04;
          atomo.scale.y = 0.04;
          atomo.scale.z = 0.04;

          object.material.opacity = 0.1;
          object.material.transparent = true;

          object.userData.grab = false;
          object.castShadow = true;
          object.receiveShadow = true;

          atomo.userData.grab = false;
          atomo.castShadow = true;
          atomo.receiveShadow = true;

          objetos.push(object);
          scene.add(object);
        }
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.vr.enabled = true;
        container.appendChild(renderer.domElement);

        updateGUI();

        window.addEventListener("resize", onWindowResize, false);

        var controls = new THREE.DragControls(
          objetos,
          camera,
          renderer.domElement
        );

        controls.addEventListener("dragstart", dragStarCallback);
        controls.addEventListener("dragend", dragEndCallback);

        document.body.appendChild(THREE.WEBVR.createButton(renderer));

        /*
        const controllerToSelection = new Map();
        pickHelper = new ControllerPickHelper(scene, renderer, objetos);

        pickHelper.addEventListener("selectstart", event => {
          cont = 0;
          isMouseDown = true;
          makeGUI();
          const { controller, selectedObject } = event;

          selectedObject.userData.grab = true;
          startColor = selectedObject.material.color.getHex();

          velX = selectedObject.userData.velocity.x;
          velY = selectedObject.userData.velocity.y;
          velZ = selectedObject.userData.velocity.z;
          selectedObject.userData.velocity.x = 0;
          selectedObject.userData.velocity.y = 0;
          selectedObject.userData.velocity.z = 0;

          const existingSelection = controllerToSelection.get(controller);
          if (!existingSelection) {
            controllerToSelection.set(controller, {
              object: selectedObject,
              parent: selectedObject.parent
            });
            SceneUtils.detach(selectedObject, selectedObject.parent, scene);
            SceneUtils.attach(selectedObject, scene, controller);
          }

          var aux = logica.cambioColor(startColor);
          var aux2 = logica.game(startColor);
        });

        pickHelper.addEventListener("selectend", event => {
          isMouseDown = false;
          const { controller } = event;
          const selection = controllerToSelection.get(controller);
          if (selection) {
            selection.object.userData.grab = false;
            selection.object.userData.velocity.x = velX / 2;
            selection.object.userData.velocity.y = velY / 2;
            selection.object.userData.velocity.z = velZ / 2;
            controllerToSelection.delete(controller);
            SceneUtils.detach(selection.object, controller, scene);
            SceneUtils.attach(selection.object, scene, selection.parent);
          }
          document.getElementById("causa").innerHTML = logica.game(startColor);
          document.getElementById("pregunta").innerHTML = logica.pregunta;
        });
        */

        GUIGuia(light);
        initMusic();
      }

      function GUIGuia(light) {
        gui2 = dat.GUIVR.create("Colores: ");

        gui2.position.set(-0.25, 2.3, -1);
        gui2.rotation.set(Math.PI / 20, 0, 0);
        scene.add(gui2);

        gui2
          .add(light.position, "y", 0, 0)
          .step(1)
          .name("H: Blanco");

        gui2
          .add(light.position, "y", 0, 0)
          .step(1)
          .name("O: Rojo");
        gui2
          .add(light.position, "y", 0, 0)
          .step(1)
          .name("C: Gris");
        gui2
          .add(light.position, "y", 0, 0)
          .step(1)
          .name("Na: Verde");
        gui2
          .add(light.position, "y", 0, 0)
          .step(1)
          .name("Cl: Amarillo");
        gui2
          .add(light.position, "y", 0, 0)
          .step(1)
          .name("Si: Morado");
      }

      function initMusic() {
        geoMusic = new THREE.Mesh(
          new THREE.SphereGeometry(0.1, 0.1, 0.1),
          new THREE.MeshLambertMaterial({ wireframe: true })
        );
        geoMusic.position.y = 2;
        geoMusic.position.z = -0.8;
        scene.add(geoMusic);

        var listener = new THREE.AudioListener();
        camera.add(listener);
        var audioLoader = new THREE.AudioLoader();

        ambientalMusic = new THREE.PositionalAudio(listener);
        audioLoader.load("./assets/Music/FromHere.ogg", function(buffer) {
          ambientalMusic.setBuffer(buffer);
          ambientalMusic.setLoop(true);
          ambientalMusic.setVolume(0.15);
          ambientalMusic.setRefDistance(80);
          ambientalMusic.play();
        });
        geoMusic.add(ambientalMusic);

        var seaMusic = new THREE.Audio(listener);
        audioLoader.load("./assets/Music/0267.ogg", function(buffer) {
          seaMusic.setBuffer(buffer);
          seaMusic.setLoop(true);
          seaMusic.setVolume(0.1);
          seaMusic.play();
        });
        agua.add(seaMusic);

        completaSound = new THREE.Audio(listener);
        audioLoader.load("./assets/Music/1112.ogg", function(buffer) {
          completaSound.setBuffer(buffer);
          completaSound.setVolume(1);
        });
        agua.add(completaSound);

        goodSound = new THREE.Audio(listener);
        audioLoader.load("./assets/Music/pull-out.ogg", function(buffer) {
          goodSound.setBuffer(buffer);
          goodSound.setVolume(1);
        });
        agua.add(goodSound);

        failSound = new THREE.Audio(listener);
        audioLoader.load("./assets/Music/1501.ogg", function(buffer) {
          failSound.setBuffer(buffer);
          failSound.setVolume(1);
        });
        agua.add(failSound);

        fullSound = new THREE.Audio(listener);
        audioLoader.load("./assets/Music/0128.ogg", function(buffer) {
          fullSound.setBuffer(buffer);
          fullSound.setVolume(0.05);
        });
        agua.add(fullSound);

        lose = new THREE.Audio(listener);
        audioLoader.load("./assets/Music/StormMagic.ogg", function(buffer) {
          lose.setBuffer(buffer);
          lose.setVolume(0.05);
        });
        agua.add(lose);
      }

      function dragStarCallback(event) {
        cont = 0;
        isMouseDown = true;
        event.object.userData.grab = true;
        startColor = event.object.material.color.getHex();
        makeGUI();
        velX = event.object.userData.velocity.x;
        velY = event.object.userData.velocity.y;
        velZ = event.object.userData.velocity.z;
        event.object.userData.velocity.x = 0;
        event.object.userData.velocity.y = 0;
        event.object.userData.velocity.z = 0;
        event.object.material.color.setHex(0x000000);
      }

      function dragEndCallback(event) {
        isMouseDown = false;
        event.object.userData.grab = false;
        event.object.userData.velocity.x = velX / 2;
        event.object.userData.velocity.y = velY / 2;
        event.object.userData.velocity.z = velZ / 2;
        event.object.material.color.setHex(startColor);
      }

      function updateGUI() {
        scene.remove(gui);
        gui = dat.GUIVR.create("Formula a realizar: " + logica.pregunta + ".");

        gui.position.set(-0.25, 1.4, -1);
        gui.rotation.set(Math.PI / 20, 0, 0);
        scene.add(gui);
        var moles = logica.nombreMoleculaTotales;
        var atomos = logica.cantAtomosTotales;
        var cant = moles.length;
        var bandera = true;
        var tem = 0;

        for (var i = 0; i < cant; i++) {
          bandera = true;
          for (var j = i + 1; j < cant; j++)
            if (moles[i] == moles[j]) {
              bandera = false;
              break;
            }
          if (bandera) {
            aja.push(new AtomoTemp());
            temMOLE.push(moles[i]);
            gui.add(aja[tem], "cant", 0, atomos[i]).name(temMOLE[tem]);
            tem++;
          }
        }
      }

      function aumento(atomo) {
        for (var i = 0; i < temMOLE.length; i++)
          if (atomo == temMOLE[i]) {
            aja[i].cant++;
            return;
          }
      }

      function makeGUI() {
        if (contadorGUI == logica.CANTMOLECULAS - 1) {
          scene.remove(gui);
          scene.remove(gui2);
        } else if (logica.vidas > 0) {
          var nombre = logica.cambioColor(startColor);
          var dato = logica.game(startColor);
          switch (dato.charAt(0)) {
            case "P":
              if (completaSound.isPlaying) completaSound.stop();
              completaSound.play();
              logica.bandera = false;
              contadorGUI++;
              temMOLE = [];
              aja = [];
              updateGUI();
              return makeGUI();
            case "E":
              if (failSound.isPlaying) failSound.stop();
              failSound.play();
              break;
            case "G":
              if (fullSound.isPlaying) fullSound.stop();
              fullSound.play();
              break;
            case "A":
              if (goodSound.isPlaying) goodSound.stop();
              goodSound.play();
              aumento(nombre);
              updateGUI();
              break;
            case "N":
              if (lose.isPlaying) lose.stop();
              lose.play();
              break;
          }
        }
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function animate() {
        renderer.setAnimationLoop(render);
      }

      function render() {
        var x = geoMusic.position.x;
        var z = geoMusic.position.z;
        geoMusic.position.x = x * Math.cos(0.01) - z * Math.sin(0.01);
        geoMusic.position.z = z * Math.cos(0.01) + x * Math.sin(0.01);
        if (logica.vidas > 0 && contadorGUI < logica.CANTMOLECULAS - 1) {
          var delta = clock.getDelta() * 60;
          if (cont == CANTATOMOS) cont = 0;

          if (isMouseDown === true && cont < CANTATOMOS) {
            var cube = objetos[cont];
            if (!cube.userData.grab) {
              objetos.pop(0);
              cube.position.applyQuaternion(camera.quaternion);
              cube.userData.velocity.x = (Math.random() - 0.5) * 0.01 * delta;
              cube.userData.velocity.y = (Math.random() - 0.5) * 0.01 * delta;
              cube.userData.velocity.z = (Math.random() * 0.01 - 0.025) * delta;
              cube.userData.velocity.applyQuaternion(camera.quaternion);
              objetos.push(cube);
            }
            cont++;
          }

          objetos.forEach(element => {
            var cube = element;
            cube.userData.velocity.multiplyScalar(1 - 0.001 * delta);
            cube.position.add(cube.userData.velocity);
            if (
              cube.position.x < -PAREDESCUADRO ||
              cube.position.x > PAREDESCUADRO
            ) {
              cube.position.x = THREE.Math.clamp(
                cube.position.x,
                -PAREDESCUADRO,
                PAREDESCUADRO
              );
              cube.userData.velocity.x = -cube.userData.velocity.x;
            }
            if (cube.position.y < 0 || cube.position.y > PAREDESCUADRO) {
              cube.position.y = THREE.Math.clamp(
                cube.position.y,
                0,
                PAREDESCUADRO
              );
              cube.userData.velocity.y = -cube.userData.velocity.y;
            }
            if (
              cube.position.z < -PAREDESCUADRO ||
              cube.position.z > PAREDESCUADRO
            ) {
              cube.position.z = THREE.Math.clamp(
                cube.position.z,
                -PAREDESCUADRO,
                PAREDESCUADRO
              );
              cube.userData.velocity.z = -cube.userData.velocity.z;
            }
            cube.rotation.x += cube.userData.velocity.x * 2 * delta;
            cube.rotation.y += cube.userData.velocity.y * 2 * delta;
            cube.rotation.z += cube.userData.velocity.z * 2 * delta;

            objetos.forEach(element2 => {
              var object2 = element2;
              normal.copy(cube.position).sub(object2.position);
              var distance = normal.length();
              if (distance < 2 * RADIUS) {
                normal.multiplyScalar(0.5 * distance - RADIUS);
                cube.position.sub(normal);
                object2.position.add(normal);
                normal.normalize();
                relativeVelocity
                  .copy(cube.userData.velocity)
                  .sub(object2.userData.velocity);
                normal = normal.multiplyScalar(relativeVelocity.dot(normal));
                cube.userData.velocity.sub(normal);
                object2.userData.velocity.add(normal);
              }
            });

            // change '0.003' for more aggressive animation
            var time = performance.now() * 0.006;

            var aux = element.children[ 0 ];

            // change 'k' value for more spikes
            var k = 4;
            for (var i = 0; i < aux.geometry.vertices.length; i++) {
                var p = aux.geometry.vertices[i];
                p.normalize().multiplyScalar(5 + 0.5 * noise.perlin3(p.x * k + time, p.y * k, p.z * k));
            }
            aux.geometry.computeVertexNormals();
            aux.geometry.normalsNeedUpdate = true;
            aux.geometry.verticesNeedUpdate = true;

          });
        } else ambientalMusic.stop();
        //pickHelper.update(scene, delta, objetos);
        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
